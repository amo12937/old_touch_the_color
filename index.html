<html>
<head>
<style>
.board {
  display: flex;
  flex-direction: column;
  height: 480px;
  width: 480px;
}

.row {
  display: flex;
  flex-direction: row;
  flex: auto;
}

.item {
  flex: auto;
  margin: 3px;
  border-radius: 10px;
  background-color: #ffcccc;
}
</style>
<script>
onLoad = (function() {
  var NUM_OF_ITEMS = 9;
  var NUM_OF_HINTS = 4;

  var r = function(n) {
    return Math.floor(Math.random() * n);
  };

  var other = function(n, k) {
    var s = r(n - 1);
    if (s < k)
      return s;
    else
      return s + 1;
  }

  var shuffle = function(l) {
    var i, j, n, tmp;
    for (i = 0, n = l.length; i < n; i++) {
      j = r(n);
      tmp = l[j];
      l[j] = l[i];
      l[i] = tmp;
    }
    return l;
  };

  containerAndPoolProvider = function(n, m) {
    var i, l = [];
    for (i = 0; i < n + m; i++) {
      l.push(i);
    }
    l = shuffle(l);
    return {
      "container": l.slice(0, n),
      "pool": l.slice(-m),
    };
  };
 
  var observee = function() {
    var i = 0;
    var listeners = {}
    return {
      "addObserver": function (fn, thisArg) {
        listeners[i] = {
          "fn": fn,
          "thisArg": thisArg,
        }
        var del = (function(j) {
          return function() {
            delete listeners[j];
          }
        })(i);
        i += 1;
        return del;
      },
      "notify": function() {
        for (i in listeners) {
          listeners[i].fn.apply(listeners[i].thisArg, arguments);
        }
      }
    };
  };

  var hintProvider = function(n, m) {
    var cp = containerAndPoolProvider(m, n - m);

    var o = observee();

    var self = {
      "addObserver": function(fn, thisArg) {
        return o.addObserver(fn, thisArg);
      },
      "try": function(j) {
        return cp.container[0] === j;
      },
      "shift": function() {
        var i = r(n - m);
        cp.container.push(cp.pool[i]);
        cp.pool[i] = cp.container.shift();
        o.notify(self, self.get());
      },
      "get": function() {
        return cp.container.slice(0);
      },
    };

    return self;
  };

  var itemContainerProvider = function(n, m) {
    var cp = containerAndPoolProvider(n, m);
    var o = observee();

    var self = {
      "addObserver": function(fn, thisArg) {
        return o.addObserver(fn, thisArg);
      },
      "select": function(j) {
        /* select されると、値が変わる */
        if (j < 0 || n <= j) return;
        var k = r(m);
        var newItem = cp.pool[k];
        cp.pool[k] = cp.container[j];
        cp.container[j] = newItem;
        o.notify(self, j, cp.pool[k] /* oldItem */, newItem)
        return newItem;
      },
      "get": function() {
        return cp.container.slice(0);
      },
    };

    return self;
  };

  var model = (function(n, m) {
    var itemContainer = itemContainerProvider(n, n);
    var hint = hintProvider(n, m);

    var self = {
      "addItemContainerObserver": function(fn, thisArg) {
        return itemContainer.addObserver(fn, thisArg);
      },
      "addHintObserver": function(fn, thisArg) {
        return hint.addObserver(fn, thisArg);
      },
      "select": function(i) {
        if (!hint.try(i)) return;
        itemContainer.select(i);
        hint.shift();
      },
      "getItemContainer": function() {
        return itemContainer.get();
      },
      "getHint": function() {
        return hint.get();
      },
    };
    return self;
  })(NUM_OF_ITEMS, NUM_OF_HINTS);

  var controller = (function(m) {
    return function(i) {
      m.select(i);
    };
  })(model);

  var view = (function(m) {
    var hintMapper = function(items) {
      return function(i) {
        return items[i];
      }
    };
    return function(hintElm, itemElms) {
      m.addHintObserver(function(sender, hints) {
        hintElm.innerHTML = hints.map(hintMapper(m.getItemContainer())).toString();
      });
      m.addItemContainerObserver(function(sender, i, _old, _new) {
        itemElms[i].innerHTML = _new;
      });

      var hints = m.getHint();
      var items = m.getItemContainer();
      hintElm.innerHTML = hints.map(hintMapper(items)).toString();

      var i, n;
      for (i = 0, n = items.length; i < n; i++) {
        itemElms[i].innerHTML = items[i];
      }
    };
  })(model);

  var onLoad = function(d) {
    var hintElm = d.getElementById("hints");
    var i = 0, itemElms = [];
    for (i = 0; i < NUM_OF_ITEMS; i++) {
      var elm = d.getElementById("item" + i);
      elm.onclick = (function(j) {
        return function() {
          controller(j);
        };
      })(i);
      itemElms.push(elm);
    }
    view(hintElm, itemElms);
  };

  return onLoad
})();

</script>
</head>
<body onload="onLoad(document)">
<div id="hints"></div>
<br>
<div class="board">
  <div class="row">
    <div class="item" id="item0"></div>
    <div class="item" id="item1"></div>
    <div class="item" id="item2"></div>
  </div>
  <div class="row">
    <div class="item" id="item3"></div>
    <div class="item" id="item4"></div>
    <div class="item" id="item5"></div>
  </div>
  <div class="row">
    <div class="item" id="item6"></div>
    <div class="item" id="item7"></div>
    <div class="item" id="item8"></div>
  </div>
</div>
</body>
</html>
